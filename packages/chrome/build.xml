<?xml version="1.0" encoding="utf-8"?>
<project name="chrome" default=".help">

	<import file="${basedir}/.sencha/package/build-impl.xml"/>
	<target name="-init-compile-js" depends="-init-compiler">
		<x-compile refid="${compiler.ref.id}">
			<![CDATA[
				require
					--source=Ext.util.Observable
					--requires=Chrome
			]]>
		</x-compile>

		<property name="build.compile.js.root">
			<![CDATA[
				require
					--source=Ext.util.Observable
					--requires=Chrome.root.EventManager
				and
				union
					--file=core/root.js
					--recursive
				and
				exclude
					--namespace=Chrome.sandbox
				and
				include
					--tag=core
				and
				save
					root
				and
				union
					--not
					--namespace=Ext
				and
				include
					--tag=core
				and
				exclude
					--tag=dom
				and
				include
					--namespace=Ext.util.DelayedTask,Ext.util.Event,Ext.util.HashMap
				and
				exclude
					--class=Ext.Template,Ext.XTemplate,Ext.XTemplateCompiler,Ext.XTemplateParser
				and
				save
					nondom
				and
				intersect
					--sets=root,nondom
			]]>
		</property>
		<property name="build.compile.js.sandbox">
			<![CDATA[
				union
					--file=core/sandbox.js
					--recursive
				and
				exclude
					--namespace=Chrome.root
				and
				include
					--tag=core
			]]>
		</property>
	</target>

	<target name="-compile-js-debug" depends="-init-compile-js">
		<x-compile refid="${compiler.ref.id}">
			<![CDATA[
				--options=${build.compile.js.debug.options}
				${build.compile.js.root}
				and
				concatenate
					--remove-text-references=${build.remove.references}
					--output-file=${build.root.debug.js}
					${build.concat.debug.options}
				and
				meta
					--json
					--filenames
					--output=${build.root.debug.js}on
				and
				${build.compile.js.sandbox}
				and
				concatenate
					--remove-text-references=${build.remove.references}
					--output-file=${build.sandbox.debug.js}
					${build.concat.debug.options}
				and
				meta
					--json
					--filenames
					--output=${build.sandbox.debug.js}on
			]]>
		</x-compile>
	</target>

	<target name="-compile-js-non-debug" depends="-init-compile-js">
		<x-compile refid="${compiler.ref.id}">
			<![CDATA[
				--options=${build.compile.js.options}
				${build.compile.js.root}
				and
				concatenate
					--remove-text-references=${build.remove.references}
					${build.compile.js.compress}
					--output-file=${build.root.js}
					${build.concat.options}
				and
				${build.compile.js.sandbox}
				and
				concatenate
					--remove-text-references=${build.remove.references}
					${build.compile.js.compress}
					--output-file=${build.sandbox.js}
					${build.concat.options}
			]]>
		</x-compile>
	</target>

	<target name="install" depends="init">
		<x-property-file file="${workspace.dir}/${app}/.sencha/app/sencha.cfg">
			<entry
				type="string"
				operation="="
				key="chrome.frame.type"
				value="${type}" />
		</x-property-file>

		<x-property-file file="${workspace.dir}/${app}/.sencha/app/build.properties">
			<entry
				type="string"
				operation="="
				key="app.microloader.dir"
				value="${package.dir}/microloader" />
			<entry
				type="string"
				operation="="
				key="app.microloader.development"
				value="$${chrome.frame.type}.js" />
			<entry
				type="string"
				operation="="
				key="app.microloader.testing"
				value="$${chrome.frame.type}.js" />
			<entry
				type="string"
				operation="="
				key="app.microloader.production"
				value="$${chrome.frame.type}.js" />
		</x-property-file>
	</target>

</project>
